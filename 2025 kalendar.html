<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ºdc…ô Planlayƒ±cƒ±sƒ± - 2025 (Modern Calendar)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --gelir: #10b981; --xerc: #ef4444; --active: #6366f1; --border: #e2e8f0; --bg: #f8fafc; --text-main: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 16px; color: #1e293b; padding-bottom: 60px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); overflow: visible; display: flex; flex-direction: column; min-height: 800px;}
        
        /* TABS */
        .month-tabs { background: #111827; padding: 12px 20px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .month-tabs::-webkit-scrollbar { display: none; }
        .month-btn { display: inline-block; padding: 8px 16px; margin-right: 10px; background: #374151; color: white; border-radius: 12px; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .month-btn.active { background: white; color: #111827; font-weight: 600; }

        /* SUMMARY HEADER */
        .summary-header { 
            background: linear-gradient(120deg, #1e293b 0%, #334155 100%); 
            color: white; padding: 24px 0; display: grid; grid-template-columns: repeat(4, 1fr); align-items: center;
        }
        .sum-box { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border-right: 1px solid rgba(255,255,255,0.1); }
        .sum-box:last-child { border-right: none; }
        .sum-line { width: 24px; height: 4px; border-radius: 2px; margin-bottom: 8px; }
        .sum-line.start { background: #6366f1; } .sum-line.inc { background: #10b981; } .sum-line.exp { background: #ef4444; } .sum-line.end { background: #f59e0b; }
        .sum-label { font-size: 0.85rem; opacity: 0.8; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }
        .sum-val { font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; }
        @media (max-width: 768px) { .summary-header { grid-template-columns: 1fr 1fr; gap: 20px; } .sum-box { border-right: none; } }

        /* CHART */
        .yearly-section { padding: 20px 32px; border-bottom: 1px solid var(--border); background: #fff; }
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 20px; }
        .annual-summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .a-card { background: #f8fafc; padding: 15px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }
        .a-card h4 { font-size: 0.85rem; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        .a-card .val { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
        .section-title { font-size: 1.3rem; font-weight: 700; color: #1e293b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-title::before { content: ''; display: block; width: 6px; height: 24px; background: #6366f1; border-radius: 3px; }
        @media (max-width: 900px) { .annual-summary-cards { grid-template-columns: 1fr 1fr; } }

        /* TABLES */
        .tables { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 28px 32px; background: #fff; border-bottom: 1px solid var(--border); }
        @media (max-width: 900px) { .tables { grid-template-columns: 1fr; } }
        .box { background: white; border-radius: 18px; overflow: visible; box-shadow: 0 8px 25px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; }
        .box-title { padding: 14px; font-size: 1.2rem; font-weight: 700; color: white; text-align: center; border-top-left-radius: 18px; border-top-right-radius: 18px; letter-spacing: 0.5px; }
        .gelir .box-title { background: var(--gelir); }
        .xerc .box-title { background: var(--xerc); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        th { background: #f8fafc; padding: 14px 12px; font-weight: 600; color: #64748b; border-bottom: 1px solid var(--border); text-align: left; font-size: 13px; text-transform: uppercase; }
        td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; font-size: 14px; color: var(--text-main); }
        .col-no { width: 40px; text-align: center; color: #94a3b8; font-size: 12px; font-weight: 500; }
        .col-date { width: 90px; color: #475569; font-weight: 600; font-size: 13px; }
        .col-cat { width: 25%; font-weight: 500; color: #1e293b; }
        .col-note { color: #94a3b8; font-size: 13px; font-style: italic; max-width: 0; cursor: default; }
        .amount { width: 120px; font-weight: 700; text-align: right; padding-right: 15px !important; font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }
        .action-cell { width: 60px; text-align: center; position: relative; overflow: visible; }
        
        /* --- NEW CALENDAR STYLES (GLASS & FRAMES) --- */
        .calendar-wrapper { padding: 20px 32px; background: #fff; border-bottom: 1px solid var(--border); position: relative; }
        .calendar-top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-nav-btn { 
            background: #f1f5f9; border: 1px solid #e2e8f0; color: #475569; 
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s;
        }
        .cal-nav-btn:hover { background: #e2e8f0; color: #1e293b; transform: scale(1.1); }
        
        .calendar-container-scroll { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; overflow-x: auto; 
        }
        
        .single-cal { 
            border: 1px solid #e2e8f0; border-radius: 20px; padding: 15px; 
            background: #f8fafc; /* Slight bg for glass contrast */
            min-width: 300px; 
        }
        .single-cal-title { text-align: center; font-weight: 700; color: #334155; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .cal-grid-7 { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; } /* Increased gap */
        .cal-day-h { text-align: center; font-size: 11px; font-weight: 600; color: #94a3b8; padding-bottom: 4px; }
        .cal-day-h.sun { color: #ef4444; }
        
        /* GLASS CELL STYLES */
        .cal-c { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; font-size: 13px; font-weight: 500; color: #334155; 
            position: relative; cursor: default;
            
            /* Glassmorphism */
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: 0.2s ease;
        }
        .cal-c:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); background: #fff; }
        .cal-c.empty { background: transparent; border: none; box-shadow: none; }
        
        /* Today Highlighting */
        .cal-c.today { 
            background: #eef2ff; 
            border: 1.5px solid #6366f1; 
            color: #4338ca; 
            font-weight: 700; 
        }

        /* FRAMES (BORDER COLORS) */
        .cal-c.inc-day {
            border: 2px solid #10b981;
            color: #065f46;
            background: rgba(209, 250, 229, 0.5);
            font-weight: 700;
        }
        .cal-c.exp-day {
            border: 2px solid #ef4444;
            color: #7f1d1d;
            background: rgba(254, 226, 226, 0.5);
            font-weight: 700;
        }
        /* Both: Gradient Border using Box-Shadow trick for rounded corners */
        .cal-c.both-day {
            border: 1px solid transparent;
            box-shadow: inset 3px 0 0 0 #10b981, inset -3px 0 0 0 #ef4444, 0 2px 5px rgba(0,0,0,0.05);
            background: #fff;
            font-weight: 700;
        }

        @media (max-width: 1000px) { .calendar-container-scroll { grid-template-columns: 1fr; } }

        /* ACTION BUTTONS */
        .sq-btn { width: 32px; height: 32px; border-radius: 8px; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; margin: 0 auto; }
        .sq-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .sq-btn.gelir { background: #10b981; }
        .sq-btn.xerc { background: #ef4444; }
        .action-menu { position: absolute; right: 40px; top: -10px; background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 12px; width: 140px; z-index: 100; display: none; overflow: hidden; text-align: left; }
        .action-menu.show { display: block; animation: fadeIn 0.15s ease-out; }
        .action-item { padding: 12px 16px; font-size: 13px; cursor: pointer; color: #334155; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .action-item:hover { background: #f1f5f9; color: #6366f1; }
        .action-item.delete { color: #ef4444; border-top: 1px solid #f1f5f9; }
        .action-item.delete:hover { background: #fef2f2; }

        /* RECURRING STYLES */
        .recurring-row td { color: #b45309; background: #fffbeb; }
        .past-date td { background-color: #fecaca !important; color: #7f1d1d; font-weight: 500; }
        .past-date { border-left: 4px solid #dc2626 !important; }

        /* RECURRING SECTION */
        .recurring-wrapper { padding: 20px 32px 10px 32px; background: #fff; border-bottom: 1px solid var(--border); }
        .recurring-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .recurring-chevron { transition: transform 0.3s ease; width: 20px; height: 20px; opacity: 0.5; }
        .recurring-header.active .recurring-chevron { transform: rotate(180deg); }
        .recurring-title { font-size: 0.95rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .recurring-title::before { content: ''; display: block; width: 6px; height: 24px; background: #f59e0b; border-radius: 3px; }
        .recurring-content { display: none; margin-top: 20px; padding-bottom: 10px; } 
        .recurring-content.open { display: block; animation: slideDown 0.3s ease-out; }
        .rec-summary-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; background: #fff7ed; padding: 12px; border-radius: 12px; border: 1px solid #fed7aa; text-align: center; }
        .rec-sum-item span { display: block; font-size: 11px; color: #9a3412; text-transform: uppercase; margin-bottom: 4px; }
        .rec-sum-item strong { font-size: 16px; }
        .rec-split-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .rec-column { display: flex; flex-direction: column; gap: 12px; }
        .rec-col-header { font-size: 13px; font-weight: 700; text-transform: uppercase; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; margin-bottom: 8px; text-align: center; }
        .rec-col-header.gelir { color: #10b981; border-color: #10b981; }
        .rec-col-header.xerc { color: #ef4444; border-color: #ef4444; }
        @media (max-width: 768px) { .rec-split-container { grid-template-columns: 1fr; } }
        .r-item { background: white; border: 1px solid #e2e8f0; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .r-del { background: #fee2e2; border: none; color: #ef4444; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.2s; }
        .r-del:hover { background: #ef4444; color: white; }

        /* ADD FORM */
        .add-form { padding: 28px 32px; background: var(--bg); display: flex; align-items: center; gap: 16px; flex-wrap: wrap; border-top: 1px solid var(--border); }
        .add-form.recurring-style { background: #fff; border: 2px dashed #fed7aa; border-radius: 16px; padding: 24px; margin-bottom: 15px; flex-direction: column; align-items: stretch; }
        .add-form > * { flex: 1; min-width: 140px; }
        .rec-inputs-row { display: flex; gap: 16px; flex-wrap: wrap; width: 100%; align-items: center; }
        .month-selector-label { font-size: 13px; font-weight: 600; color: #9a3412; margin-bottom: 8px; display: block; }
        .month-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 16px; }
        .month-check { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px; color: #334155; background: #f8fafc; padding: 6px 10px; border-radius: 8px; border: 1px solid #cbd5e1; user-select: none; }
        .month-check:hover { background: #e2e8f0; }
        .month-check input { width: 16px; height: 16px; accent-color: #f59e0b; cursor: pointer; }
        .type-buttons { display: flex; gap: 12px; min-width: 200px; }
        .type-btn { flex: 1; padding: 14px; border: 2px solid #cbd5e1; border-radius: 14px; background: white; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s; }
        .type-btn.active { color: white; border-color: transparent; transform: translateY(-2px); }
        .type-btn.gelir.active { background: var(--gelir); }
        .type-btn.xerc.active { background: var(--xerc); }
        input, select { width: 100%; padding: 14px 16px; border: 2px solid #cbd5e1; border-radius: 14px; font-size: 15px; background: white; height: 52px; }
        input:focus, select:focus { outline: none; border-color: var(--active); box-shadow: 0 0 0 4px rgba(99,102,241,0.15); }

        /* BUTTONS */
        .modern-btn { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; padding: 0 24px; border-radius: 14px; font-weight: 600; font-size: 15px; cursor: pointer; height: 52px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: 0.3s; white-space: nowrap; }
        .modern-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4); }
        .modern-btn.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .modern-btn.orange:hover { box-shadow: 0 6px 15px rgba(245, 158, 11, 0.4); }

        .date-container { position: relative; width: 52px; height: 52px; flex: 0 0 52px !important; min-width: 52px !important; }
        .date-icon-btn { width: 100%; height: 100%; background: var(--active); border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .date-icon-btn svg { stroke: white; width: 24px; height: 24px; }
        .date-container:hover .date-icon-btn { background: #4f46e5; transform: translateY(-2px); }
        #date { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        #date::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; }

        .bottom-controls { padding: 16px 32px; background: #f1f5f9; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 16px; font-size: 14.5px; flex-wrap: wrap; margin-top: auto; }
        .bottom-controls label { font-weight: 600; color: #374151; white-space: nowrap; }
        .bottom-controls input[type="number"] { width: 140px; padding: 4px 10px; height: 34px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 15px; }
        .set-btn { background: var(--active); color: white; border: none; padding: 0 20px; height: 34px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .excel-upload-wrapper { display: flex; align-items: center; gap: 5px; background: #e0e7ff; border: 1px dashed #6366f1; color: #166534; padding: 2px 15px; height: 34px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .excel-upload-wrapper:hover { background: #c7d2fe; }
        .reset-btn-inline { display: flex; align-items: center; gap: 5px; background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 2px 15px; height: 34px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .reset-btn-inline:hover { background: #fecaca; }
        .export-btn-inline { display: flex; align-items: center; gap: 5px; background: #e0f2fe; border: 1px solid #0ea5e9; color: #0284c7; padding: 2px 15px; height: 34px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .export-btn-inline:hover { background: #bae6fd; }

        /* Tooltip */
        #rowTooltip { position: fixed; background: #1e293b; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 13px; pointer-events: none; z-index: 9999; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 250px; line-height: 1.4; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body onclick="closeAllMenus(event)">
    <div id="rowTooltip"></div>

    <div class="container">
        <div class="month-tabs" id="monthTabs"></div>

        <div class="summary-header">
            <div class="sum-box">
                <div class="sum-line start"></div>
                <span class="sum-label">Cari Qalƒ±q</span>
                <span class="sum-val" id="startBalance">0 ‚Çº</span>
            </div>
            <div class="sum-box">
                <div class="sum-line inc"></div>
                <span class="sum-label">G…ôlir C…ômi</span>
                <span class="sum-val" id="totalGelir" style="color:#10b981">0 ‚Çº</span>
            </div>
            <div class="sum-box">
                <div class="sum-line exp"></div>
                <span class="sum-label">X…ôrc C…ômi</span>
                <span class="sum-val" id="totalXerc" style="color:#ef4444">0 ‚Çº</span>
            </div>
            <div class="sum-box">
                <div class="sum-line end"></div>
                <span class="sum-label">Son Qalƒ±q</span>
                <span class="sum-val" id="endBalance">0 ‚Çº</span>
            </div>
        </div>

        <div class="yearly-section">
            <div class="section-title">BALANS Dƒ∞NAMƒ∞KASI</div>
            <div class="annual-summary-cards">
                <div class="a-card"><h4>C…ômi G…ôlir</h4><div class="val" style="color: var(--gelir)" id="yearIncome">0 ‚Çº</div></div>
                <div class="a-card"><h4>C…ômi X…ôrc</h4><div class="val" style="color: var(--xerc)" id="yearExpense">0 ‚Çº</div></div>
                <div class="a-card"><h4>Xalis F…ôrq</h4><div class="val" style="color: var(--active)" id="yearNet">0 ‚Çº</div></div>
                <div class="a-card" style="background:#eef2ff; border-color:#6366f1;">
                    <h4 style="color:#4338ca;">Cari Balans (Bu g√ºn)</h4>
                    <div class="val" style="color: #4338ca" id="yearFinalBalance">0 ‚Çº</div>
                </div>
            </div>
            <div class="chart-container"><canvas id="budgetChart"></canvas></div>
        </div>

        <div class="tables">
            <div class="box gelir">
                <div class="box-title">G∆èLƒ∞RL∆èR</div>
                <table>
                    <thead><tr><th class="col-no">‚Ññ</th><th class="col-date">Tarix</th><th class="col-cat">Kateqoriya</th><th class="col-note" style="padding-left:10px;">Qeyd</th><th class="amount">M…ôbl…ôƒü</th><th class="action-cell"></th></tr></thead>
                    <tbody id="gelirBody"></tbody>
                </table>
            </div>
            <div class="box xerc">
                <div class="box-title">X∆èRCL∆èR</div>
                <table>
                    <thead><tr><th class="col-no">‚Ññ</th><th class="col-date">Tarix</th><th class="col-cat">Kateqoriya</th><th class="col-note" style="padding-left:10px;">Qeyd</th><th class="amount">M…ôbl…ôƒü</th><th class="action-cell"></th></tr></thead>
                    <tbody id="xercBody"></tbody>
                </table>
            </div>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-top-nav">
                <div class="section-title" style="margin:0;">üìÖ T…ôqvim ƒ∞cmalƒ±</div>
                <div style="display:flex; gap:10px;">
                    <button class="cal-nav-btn" onclick="shiftCalendar(-1)">‚ùÆ</button>
                    <button class="cal-nav-btn" onclick="shiftCalendar(1)">‚ùØ</button>
                </div>
            </div>
            <div class="calendar-container-scroll" id="multiCalendar"></div>
        </div>

        <div class="recurring-wrapper">
            <div class="recurring-header" onclick="toggleRecurring()" id="recHeader">
                <div class="recurring-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                    Aylƒ±q √ñd…ôni≈ül…ôr 
                </div>
                <svg class="recurring-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            <div class="recurring-content" id="recurringContent">
                <div class="rec-summary-panel">
                    <div class="rec-sum-item"><span>Aylƒ±q sabit g…ôlir</span><strong style="color:var(--gelir)" id="recSumInc">0 ‚Çº</strong></div>
                    <div class="rec-sum-item"><span>Aylƒ±q sabit x…ôrc</span><strong style="color:var(--xerc)" id="recSumExp">0 ‚Çº</strong></div>
                    <div class="rec-sum-item"><span>F…ôrq</span><strong style="color:#92400e" id="recSumNet">0 ‚Çº</strong></div>
                </div>
                <div class="add-form recurring-style">
                    <span class="month-selector-label">Hansƒ± aylara ≈üamil edilsin?</span>
                    <div class="month-grid" id="monthSelector"></div>

                    <div class="rec-inputs-row">
                        <div class="type-buttons">
                            <button class="type-btn gelir active" onclick="setRecType('gelir')">G…ôlir</button>
                            <button class="type-btn xerc" onclick="setRecType('xerc')">X…ôrc</button>
                        </div>
                        <select id="recDay" style="max-width: 100px;"><option value="" disabled selected>G√ºn</option></select>
                        <select id="recCategory"><option value="" disabled selected>Kateqoriya</option></select>
                        <input type="text" id="recNote" placeholder="Qeyd (Aylƒ±q)">
                        <input type="number" id="recAmount" placeholder="M…ôbl…ôƒü ‚Çº">
                        <button class="modern-btn orange" onclick="addRecurring()">≈ûablona ∆èlav…ô Et</button>
                    </div>
                </div>
                
                <div class="rec-split-container">
                    <div class="rec-column">
                        <div class="rec-col-header gelir">G…ôlir ≈ûablonlarƒ±</div>
                        <div id="recurringListGelir"></div>
                    </div>
                    <div class="rec-column">
                        <div class="rec-col-header xerc">X…ôrc ≈ûablonlarƒ±</div>
                        <div id="recurringListXerc"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="add-form">
            <div class="type-buttons">
                <button class="type-btn gelir active" onclick="setType('gelir')">G…ôlir</button>
                <button class="type-btn xerc" onclick="setType('xerc')">X…ôrc</button>
            </div>
            <div class="date-container" title="Tarix se√ßin">
                <div class="date-icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                </div>
                <input type="date" id="date" required>
            </div>
            <select id="category"><option value="" disabled selected>Kateqoriya</option></select>
            <input type="text" id="note" placeholder="Qeyd (isteƒüe baƒülƒ±)">
            <input type="number" id="amount" step="0.01" min="0" placeholder="M…ôbl…ôƒü ‚Çº">
            <button class="modern-btn" onclick="addEntry()">Cari Aya ∆èlav…ô Et</button>
        </div>

        <div class="bottom-controls">
            <label>Cari qalƒ±q (…ôl il…ô):</label>
            <input type="number" step="0.01" id="manualStartBalance" placeholder="0.00">
            <button class="set-btn" onclick="setManualStartBalance()">T…ôyin et</button>
            <div class="excel-upload-wrapper" onclick="document.getElementById('excelFile').click()">
                <span>üìÑ Excel-d…ôn</span>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .xlsm" style="display: none;" onchange="handleExcelUpload(this)">
            </div>
            
            <div class="export-btn-inline" onclick="exportToClipboard()">
                <span>üì∏ ≈û…ôkil </span>
            </div>

            <div class="reset-btn-inline" onclick="resetAllData()"><span>üóëÔ∏è Sƒ±fƒ±rla</span></div>
            <span style="margin-left: auto; color: #64748b; font-size: 13px;">Se√ßilib: <strong id="currentMonthLabel"></strong></span>
        </div>
    </div>

    <script>
        let data = JSON.parse(localStorage.getItem('budgetApp2025')) || [];
        let balances = JSON.parse(localStorage.getItem('budgetBalances2025')) || {};
        let recurringData = JSON.parse(localStorage.getItem('budgetRecurring2025')) || [];
        let recurringOverrides = JSON.parse(localStorage.getItem('budgetOverrides2025')) || {}; 
        
        let currentType = 'gelir';
        let recType = 'gelir';
        let selectedMonth = 'all';
        let calendarStartOffset = 0;
        
        const tooltip = document.getElementById('rowTooltip');
        let budgetChart = null;
        const monthsAz = ["Yanvar","Fevral","Mart","Aprel","May","ƒ∞yun","ƒ∞yul","Avqust","Sentyabr","Oktyabr","Noyabr","Dekabr"];

        function init() {
            const daySelect = document.getElementById('recDay');
            for(let i=1; i<=31; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = i + "-i";
                daySelect.appendChild(opt);
            }
            
            const monthGrid = document.getElementById('monthSelector');
            monthsAz.forEach((m, index) => {
                const lbl = document.createElement('label');
                lbl.className = 'month-check';
                lbl.innerHTML = `<input type="checkbox" value="${index+1}" checked> ${m}`;
                monthGrid.appendChild(lbl);
            });

            updateCategoryList();
            updateRecCategoryList();
            renderRecurringList();
            render();
        }

        function closeAllMenus(e) {
            if (!e.target.closest('.action-cell')) {
                document.querySelectorAll('.action-menu').forEach(m => m.classList.remove('show'));
            }
        }

        function toggleActionMenu(btn) {
            const menu = btn.nextElementSibling;
            document.querySelectorAll('.action-menu').forEach(m => { if(m !== menu) m.classList.remove('show'); });
            menu.classList.toggle('show');
        }

        function formatMoney(amount) {
            if (amount % 1 === 0) return amount.toFixed(0) + ' ‚Çº';
            return amount.toFixed(2) + ' ‚Çº';
        }

        function checkTooltip(cell) {
            if (cell.scrollWidth > cell.clientWidth) {
                showTooltip(cell, cell.innerText);
            }
        }

        function showTooltip(element, text) {
            const rect = element.getBoundingClientRect();
            tooltip.style.display = 'block';
            tooltip.innerHTML = text;
            tooltip.style.left = (rect.left + 10) + 'px';
            tooltip.style.top = (rect.bottom + 5) + 'px';
        }
        function hideTooltip() { tooltip.style.display = 'none'; }

        function toggleRecurring() { 
            const content = document.getElementById('recurringContent');
            const header = document.getElementById('recHeader');
            content.classList.toggle('open'); 
            header.classList.toggle('active');
        }
        function setRecType(t) { recType = t; document.querySelectorAll('.recurring-wrapper .type-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.recurring-wrapper .type-btn.${t}`).classList.add('active'); updateRecCategoryList(); }
        function updateRecCategoryList() {
            const cat = document.getElementById('recCategory'); cat.innerHTML = '<option value="" disabled selected>Kateqoriya</option>';
            (recType === 'gelir' ? gelirCategories : xercCategories).forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; cat.appendChild(opt); });
        }
        
        function addRecurring() {
            const day = document.getElementById('recDay').value;
            const cat = document.getElementById('recCategory').value;
            const note = document.getElementById('recNote').value;
            const amt = parseFloat(document.getElementById('recAmount').value);
            
            if(!day || !cat || !amt) { alert('≈ûablon m…ôlumatlarƒ±nƒ± tam doldurun.'); return; }
            
            const checkedBoxes = document.querySelectorAll('#monthSelector input:checked');
            if(checkedBoxes.length === 0) { alert("∆èn azƒ± bir ay se√ßm…ôlisiniz!"); return; }
            
            let targetMonths = [];
            const currentYear = new Date().getFullYear();
            
            checkedBoxes.forEach(cb => {
                let mIndex = parseInt(cb.value) - 1;
                let monthKey = `${currentYear}-${String(mIndex + 1).padStart(2, '0')}`;
                targetMonths.push(monthKey);
            });

            recurringData.push({ 
                id: Date.now(), type: recType, day: parseInt(day), 
                category: cat, amount: amt, note: note, targetMonths: targetMonths 
            });
            localStorage.setItem('budgetRecurring2025', JSON.stringify(recurringData));
            document.getElementById('recAmount').value = ''; document.getElementById('recNote').value = '';
            renderRecurringList(); render();
        }

        function deleteRecurring(id) {
            if(confirm('Silinsin?')) {
                recurringData = recurringData.filter(item => item.id !== id);
                localStorage.setItem('budgetRecurring2025', JSON.stringify(recurringData));
                renderRecurringList(); render();
            }
        }
        
        function renderRecurringList() {
            const listGelir = document.getElementById('recurringListGelir');
            const listXerc = document.getElementById('recurringListXerc');
            listGelir.innerHTML = '';
            listXerc.innerHTML = '';
            
            let totalInc = 0, totalExp = 0;

            recurringData.forEach(item => {
                if(item.type === 'gelir') totalInc += item.amount; else totalExp += item.amount;

                const div = document.createElement('div'); div.className = 'r-item';
                const noteText = item.note ? ` <i style="color:#666; font-size:11px;">(${item.note})</i>` : '';
                
                let monthsText = "";
                if (item.targetMonths && item.targetMonths.length > 0) {
                    if (item.targetMonths.length === 12) monthsText = ` <span style="font-size:10px; color:#64748b; margin-left:2px;">‚Ä¢ 01-12 aylar</span>`;
                    else {
                        let first = item.targetMonths[0].split('-')[1];
                        let last = item.targetMonths[item.targetMonths.length - 1].split('-')[1];
                        monthsText = ` <span style="font-size:10px; color:#64748b; margin-left:2px;">‚Ä¢ ${first}-${last} aylar</span>`;
                    }
                }

                div.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <div style="display:flex; align-items:center; gap: 6px;">
                            <span class="r-tag ${item.type}">${item.type==='gelir'?'G':'X'}</span>
                            <span style="font-weight:700; color:#1e293b; font-size:14px;">${item.category}</span>
                        </div>
                        <div style="font-size:11px; color:#64748b; margin-left: 2px;">
                            Ayƒ±n <strong>${item.day}</strong>-i ${monthsText} ${noteText}
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong>${formatMoney(item.amount)}</strong>
                        <button class="r-del" onclick="deleteRecurring(${item.id})">√ó</button>
                    </div>
                `;
                
                if(item.type === 'gelir') listGelir.appendChild(div);
                else listXerc.appendChild(div);
            });

            document.getElementById('recSumInc').textContent = formatMoney(totalInc);
            document.getElementById('recSumExp').textContent = formatMoney(totalExp);
            const diff = totalInc - totalExp;
            const netElem = document.getElementById('recSumNet');
            netElem.textContent = (diff>0?'+':'') + formatMoney(diff);
            netElem.style.color = diff >= 0 ? '#166534' : '#991b1b';
        }

        function handleExcelUpload(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const d = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(d, {type: 'array'});
                    const worksheet = workbook.Sheets["Hesablama"];
                    if (!worksheet) { alert(`"Hesablama" s…ôhif…ôsi tapƒ±lmadƒ±!`); input.value = ''; return; }
                    const cell = worksheet["D3"];
                    let val = (cell && cell.v !== undefined) ? parseFloat(cell.v) : 0;
                    if(!isNaN(val)) {
                        document.getElementById('manualStartBalance').value = val.toFixed(2);
                        setManualStartBalance();
                        alert(`D3-d…ôn q…ôbul edildi: ${formatMoney(val)}`);
                    } else { alert("D3 bo≈üdur."); }
                } catch (e) { console.error(e); alert("Fayl x…ôtasƒ±."); }
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // FOTO KOPYALAMA
        async function exportToClipboard() {
            try {
                document.body.style.cursor = 'wait';
                const element = document.querySelector('.container');
                const canvas = await html2canvas(element, { 
                    scale: 1.5, backgroundColor: "#f8fafc", 
                    ignoreElements: (el) => el.classList.contains('bottom-controls') 
                });
                
                canvas.toBlob(async (blob) => {
                    await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
                    alert("‚úÖ ≈û…ôkil bufer…ô kopyalandƒ±!");
                    document.body.style.cursor = 'default';
                });
            } catch (err) { console.error(err); alert("X…ôta: " + err.message); document.body.style.cursor = 'default'; }
        }

        function getCurrentMonthKey() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }
        function getMonthName(key) { if (key === 'all') return "B√ºt√ºn Aylar"; const [y, m] = key.split('-'); return `${monthsAz[parseInt(m)-1]} ${y}`; }
        function getAllMonths() { 
            const m = new Set(); 
            data.forEach(i => i.monthYear && m.add(i.monthYear)); 
            recurringData.forEach(rec => {
                if(rec.targetMonths) rec.targetMonths.forEach(tm => m.add(tm));
            });
            m.add(getCurrentMonthKey()); 
            return Array.from(m).sort(); 
        }
        
        function getCombinedDataForMonth(monthKey) {
            let manualItems = data.filter(i => i.monthYear === monthKey);
            const [year, month] = monthKey.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let generatedRecurring = [];
            recurringData.forEach(rec => {
                if (rec.targetMonths && !rec.targetMonths.includes(monthKey)) return;

                const overrideKey = `${rec.id}_${monthKey}`;
                const isOverridden = recurringOverrides.hasOwnProperty(overrideKey);
                const finalAmount = isOverridden ? recurringOverrides[overrideKey] : rec.amount;

                let actualDay = Math.min(rec.day, daysInMonth);
                let dateStr = `${year}-${String(month).padStart(2,'0')}-${String(actualDay).padStart(2,'0')}`;
                let finalNote = rec.note ? `(Aylƒ±q: ${rec.note})` : '(Aylƒ±q √ñd…ôni≈ü)';
                if(isOverridden) finalNote += ' [D√ºz…ôli≈ü]';

                generatedRecurring.push({ 
                    ...rec, date: dateStr, monthYear: monthKey, note: finalNote, 
                    isRecurring: true, amount: finalAmount, originalId: rec.id
                });
            });
            return [...manualItems, ...generatedRecurring];
        }

        function editEntry(type, identifier, amount, monthKey) {
            const newAmount = prompt("Yeni m…ôbl…ôƒüi daxil edin:", amount);
            if (newAmount !== null && !isNaN(parseFloat(newAmount))) {
                if(type === 'recurring') {
                    const overrideKey = `${identifier}_${monthKey}`;
                    recurringOverrides[overrideKey] = parseFloat(newAmount);
                    localStorage.setItem('budgetOverrides2025', JSON.stringify(recurringOverrides));
                } else {
                    const [date, cType, oldAmt] = identifier.split('|');
                    const idx = data.findIndex(i => i.date === date && i.type === cType && i.amount == oldAmt);
                    if(idx !== -1) {
                        data[idx].amount = parseFloat(newAmount);
                        localStorage.setItem('budgetApp2025', JSON.stringify(data));
                    }
                }
                render();
            }
        }

        function deleteEntryWrapper(type, identifier, monthKey) {
             if(confirm('Silinsin?')) {
                if(type === 'recurring') {
                    const overrideKey = `${identifier}_${monthKey}`;
                    recurringOverrides[overrideKey] = 0;
                    localStorage.setItem('budgetOverrides2025', JSON.stringify(recurringOverrides));
                } else {
                    const [date, cType, oldAmt] = identifier.split('|');
                    data = data.filter(i => !(i.date === date && i.type === cType && i.amount == oldAmt));
                    localStorage.setItem('budgetApp2025', JSON.stringify(data));
                }
                render();
             }
        }

        // --- 3-MONTH CALENDAR LOGIC ---
        function shiftCalendar(step) {
            calendarStartOffset += step;
            render();
        }

        function renderMultiCalendar(displayData, monthKey) {
            const container = document.getElementById('multiCalendar');
            container.innerHTML = '';

            let baseDate;
            if (monthKey === 'all') {
                baseDate = new Date();
            } else {
                const [y, m] = monthKey.split('-').map(Number);
                baseDate = new Date(y, m - 1, 1);
            }

            baseDate.setMonth(baseDate.getMonth() + calendarStartOffset);

            for (let i = 0; i < 3; i++) {
                let currentMonthDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, 1);
                const year = currentMonthDate.getFullYear();
                const month = currentMonthDate.getMonth();

                const calDiv = document.createElement('div');
                calDiv.className = 'single-cal';
                
                const title = document.createElement('div');
                title.className = 'single-cal-title';
                title.textContent = `${monthsAz[month]} ${year}`;
                calDiv.appendChild(title);

                const headerRow = document.createElement('div');
                headerRow.className = 'cal-grid-7';
                ["B.e","√á.a","√á","C.a","C","≈û","B"].forEach((d, idx) => {
                    const h = document.createElement('div');
                    h.className = 'cal-day-h' + (idx===6 ? ' sun' : '');
                    h.textContent = d;
                    headerRow.appendChild(h);
                });
                calDiv.appendChild(headerRow);

                const grid = document.createElement('div');
                grid.className = 'cal-grid-7';
                
                let monthEvents = {};
                let thisMonthKey = `${year}-${String(month + 1).padStart(2,'0')}`;
                let thisMonthData = getCombinedDataForMonth(thisMonthKey);
                
                thisMonthData.forEach(item => {
                    if(item.amount === 0) return;
                    const d = new Date(item.date);
                    const day = d.getDate();
                    if(!monthEvents[day]) monthEvents[day] = { inc: false, exp: false };
                    if(item.type === 'gelir') monthEvents[day].inc = true;
                    else monthEvents[day].exp = true;
                });

                const firstDayIndex = new Date(year, month, 1).getDay();
                const startOffset = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let j = 0; j < startOffset; j++) {
                    const empty = document.createElement('div');
                    empty.className = 'cal-c empty';
                    grid.appendChild(empty);
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'cal-c';
                    if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === d) {
                        cell.classList.add('today');
                    }
                    
                    cell.innerHTML = `<span>${d}</span>`;
                    
                    if (monthEvents[d]) {
                        if (monthEvents[d].inc && monthEvents[d].exp) cell.classList.add('both-day');
                        else if (monthEvents[d].inc) cell.classList.add('inc-day');
                        else if (monthEvents[d].exp) cell.classList.add('exp-day');
                    }
                    grid.appendChild(cell);
                }
                calDiv.appendChild(grid);
                container.appendChild(calDiv);
            }
        }

        function createMonthTabs() {
            const tabs = document.getElementById('monthTabs'); tabs.innerHTML = '';
            const all = document.createElement('div'); all.className = 'month-btn';
            if (selectedMonth === 'all') all.classList.add('active'); all.textContent = 'B√ºt√ºn Aylar'; all.onclick = () => selectMonth('all'); tabs.appendChild(all);
            getAllMonths().forEach(m => {
                const b = document.createElement('div'); b.className = 'month-btn'; b.textContent = getMonthName(m); b.onclick = () => selectMonth(m);
                if (m === selectedMonth) b.classList.add('active'); tabs.appendChild(b);
            });
            document.getElementById('currentMonthLabel').textContent = getMonthName(selectedMonth);
        }
        function selectMonth(m) { selectedMonth = m; calendarStartOffset = 0; render(); }
        function getStartBalance(m) { return (balances[m] && balances[m].start !== undefined) ? balances[m].start : 0; }
        function setManualStartBalance() {
            const val = parseFloat(document.getElementById('manualStartBalance').value) || 0;
            if (!balances[selectedMonth]) balances[selectedMonth] = {};
            balances[selectedMonth].start = val;
            localStorage.setItem('budgetBalances2025', JSON.stringify(balances));
            render();
        }
        function saveEndBalance(m, val) { if (m === 'all') return; if (!balances[m]) balances[m] = {}; balances[m].end = val; localStorage.setItem('budgetBalances2025', JSON.stringify(balances)); }
        function resetAllData() {
            if(confirm('Dƒ∞QQ∆èT! B√ºt√ºn m…ôlumatlar silin…ôc…ôk. ∆èminsiniz?')) {
                localStorage.removeItem('budgetApp2025'); 
                localStorage.removeItem('budgetBalances2025'); 
                localStorage.removeItem('budgetRecurring2025');
                localStorage.removeItem('budgetOverrides2025');
                data = []; balances = {}; recurringData = []; recurringOverrides = {}; location.reload();
            }
        }
        const gelirCategories = ["∆èm…ôkhaqqƒ±","T…ôqa√ºd","M√ºkafat","M…ôzuniyy…ôt / Ezam","∆èDV/CashBack","Borc Qaytarmasƒ±","Satƒ±≈ü","∆èlav…ô G…ôlir","Kredit x…ôtti","Borc alƒ±nmasƒ±","Kredit alƒ±nmasƒ±"];
        const xercCategories = ["Kredit √∂d…ôni≈üi","Komissiya","Taksit √∂d…ôni≈üi","Borc qaytarmasƒ±","Kiray…ô","Komunnal","Kontur","ƒ∞nternet","T…ôhsil","Siqaret","Yol","∆èrzaq","Restoran","R√ºsum","T…ômir tikinti","Tibb","Tibb (Ana)","Ev (Quba)","ƒ∞dman","Hobby","H…ôdiyy…ô","Geyim","∆è≈üya","Dig…ôr","Borc verilm…ôsi","Toy","∆èyl…ônc…ô","B…ôrb…ôr","T…ômizlik vasit…ôl…ôri","ƒ∞≈ü √º√ß√ºn","S…ôyah…ôt","Heyvan m…ôhsullarƒ±","Baƒü"];
        function formatDateShort(iso) { const d = new Date(iso); return `${String(d.getDate()).padStart(2, '0')} ${monthsAz[d.getMonth()]}`; }
        function setType(t) { currentType = t; document.querySelectorAll('.add-form:not(.recurring-style) .type-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.add-form:not(.recurring-style) .type-btn.${t}`).classList.add('active'); updateCategoryList(); }
        function updateCategoryList() { const c = document.getElementById('category'); c.innerHTML = '<option value="" disabled selected>Kateqoriya</option>'; (currentType === 'gelir' ? gelirCategories : xercCategories).forEach(i => { const o = document.createElement('option'); o.value = i; o.textContent = i; c.appendChild(o); }); }
        
        function getGradient(ctx) {
            const c = ctx.chart; const {ctx: cx, chartArea: ca, scales: sc} = c; if (!ca) return null;
            const scY = sc.y; const zero = scY.getPixelForValue(0); const top = ca.top; const bot = ca.bottom;
            const g = cx.createLinearGradient(0, top, 0, bot);
            let stop = (zero - top) / (bot - top); if (stop < 0) stop = 0; if (stop > 1) stop = 1;
            g.addColorStop(0, '#10b981'); g.addColorStop(stop, '#10b981'); g.addColorStop(stop, '#ef4444'); g.addColorStop(1, '#ef4444'); return g;
        }
        function getFillGradient(ctx) {
            const c = ctx.chart; const {ctx: cx, chartArea: ca, scales: sc} = c; if (!ca) return null;
            const scY = sc.y; const zero = scY.getPixelForValue(0); const top = ca.top; const bot = ca.bottom;
            const g = cx.createLinearGradient(0, top, 0, bot);
            let stop = (zero - top) / (bot - top); if (stop < 0) stop = 0; if (stop > 1) stop = 1;
            g.addColorStop(0, 'rgba(16, 185, 129, 0.4)'); g.addColorStop(stop, 'rgba(16, 185, 129, 0.05)');
            g.addColorStop(stop, 'rgba(239, 68, 68, 0.05)'); g.addColorStop(1, 'rgba(239, 68, 68, 0.4)'); return g;
        }

        function renderChartAndAnnualStats(displayData) {
            let tG = 0, tX = 0; displayData.forEach(i => i.type==='gelir' ? tG+=i.amount : tX+=i.amount);
            document.getElementById('yearIncome').textContent = formatMoney(Math.round(tG));
            document.getElementById('yearExpense').textContent = formatMoney(Math.round(tX));
            const net = Math.round(tG - tX); 
            const ne = document.getElementById('yearNet'); 
            ne.textContent = (net > 0 ? '+' : '') + formatMoney(net); 
            ne.style.color = net >= 0 ? '#10b981' : '#ef4444';
            
            const sorted = [...displayData].sort((a, b) => new Date(a.date) - new Date(b.date));
            let startBal = parseFloat(document.getElementById('manualStartBalance').value) || 0;
            let labels = [], chartData = [];
            
            if (selectedMonth !== 'all') {
                const [y, m] = selectedMonth.split('-'); labels.push(`01 ${monthsAz[parseInt(m)-1]}`); chartData.push(startBal);
            } else { labels.push("Ba≈ülanƒüƒ±c"); chartData.push(startBal); }

            let daily = {}; sorted.forEach(i => { if (!daily[i.date]) daily[i.date] = 0; daily[i.date] += (i.type==='gelir' ? i.amount : -i.amount); });
            let running = startBal; Object.keys(daily).sort().forEach(d => { running += daily[d]; labels.push(formatDateShort(d)); chartData.push(running); });

            // REAL TODAY BALANCE LOGIC
            let todayBal = startBal;
            const endOfToday = new Date();
            endOfToday.setHours(23, 59, 59, 999);

            sorted.forEach(i => {
                const itemDate = new Date(i.date);
                if (itemDate <= endOfToday) {
                     if(i.type === 'gelir') todayBal += i.amount;
                     else todayBal -= i.amount;
                }
            });
            document.getElementById('yearFinalBalance').textContent = formatMoney(Math.round(todayBal));

            const ctx = document.getElementById('budgetChart').getContext('2d');
            if(budgetChart) budgetChart.destroy();

            budgetChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Balans', data: chartData, borderWidth: 3, tension: 0.4, fill: true, pointRadius: 4, pointHoverRadius: 6, cubicInterpolationMode: 'monotone', borderColor: getGradient, backgroundColor: getFillGradient, pointBackgroundColor: getGradient, pointBorderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { padding: 12, backgroundColor: '#1e293b', callbacks: { label: c => 'Balans: ' + formatMoney(c.parsed.y) } } }, scales: { y: { grid: { color: '#e2e8f0', borderDash: [5,5] }, ticks: { callback: v => formatMoney(v) } }, x: { grid: { display: false } } } },
                plugins: [{
                    id: 'monthDividers',
                    beforeDraw: (chart) => {
                        if (selectedMonth !== 'all') return;
                        const {ctx, chartArea: {top, bottom}, scales: {x}} = chart;
                        const lbls = chart.data.labels;
                        ctx.save(); ctx.beginPath(); ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)'; ctx.setLineDash([5, 5]);
                        for (let i = 1; i < lbls.length; i++) {
                            let prevParts = lbls[i-1].split(' '); let currParts = lbls[i].split(' ');
                            if(prevParts.length < 2 || currParts.length < 2) continue;
                            if (prevParts[1] !== currParts[1]) { const xPos = (x.getPixelForValue(i-1) + x.getPixelForValue(i)) / 2; ctx.moveTo(xPos, top); ctx.lineTo(xPos, bottom); }
                        }
                        ctx.stroke(); ctx.restore();
                    }
                }]
            });
        }

        function render() {
            createMonthTabs(); const start = getStartBalance(selectedMonth);
            document.getElementById('startBalance').textContent = formatMoney(start);
            document.getElementById('manualStartBalance').value = start;

            let displayData = [];
            if (selectedMonth === 'all') { const allMs = getAllMonths(); allMs.forEach(m => { displayData = [...displayData, ...getCombinedDataForMonth(m)]; }); }
            else { displayData = getCombinedDataForMonth(selectedMonth); }

            let tG = 0, tX = 0; displayData.forEach(i => i.type==='gelir' ? tG+=i.amount : tX+=i.amount);
            const end = start + tG - tX; saveEndBalance(selectedMonth, end);
            
            // Yuvarlaq totallar
            document.getElementById('totalGelir').textContent = formatMoney(Math.round(tG));
            document.getElementById('totalXerc').textContent = formatMoney(Math.round(tX));
            document.getElementById('endBalance').textContent = formatMoney(Math.round(end));
            
            const sorted = displayData.sort((a,b) => new Date(a.date) - new Date(b.date));
            const today = new Date(); today.setHours(0,0,0,0);

            document.getElementById('gelirBody').innerHTML = ''; document.getElementById('xercBody').innerHTML = '';
            let gC=0, xC=0;
            
            sorted.forEach(i => {
                if(i.amount === 0) return; 

                const r = document.createElement('tr');
                if(i.isRecurring) r.classList.add('recurring-row');
                
                const entryDate = new Date(i.date);
                if(entryDate < today) r.classList.add('past-date');

                r.innerHTML = `
                    <td>${i.type==='gelir' ? ++gC : ++xC}</td>
                    <td class="col-date">${formatDateShort(i.date)}</td>
                    <td class="col-cat">${i.category}</td>
                    <td class="col-note" onmouseenter="checkTooltip(this)" onmouseleave="hideTooltip()">${i.note || ''}</td>
                    <td class="amount">${formatMoney(i.amount)}</td>
                    <td class="action-cell">
                        <button class="sq-btn ${i.type}" onclick="toggleActionMenu(this)">‚Ä¢‚Ä¢‚Ä¢</button>
                        <div class="action-menu">
                            <div class="action-item" onclick="editEntry('${i.isRecurring ? 'recurring' : 'manual'}', '${i.isRecurring ? i.originalId : i.date+'|'+i.type+'|'+i.amount}', ${i.amount}, '${i.monthYear}')">
                                <span>‚úèÔ∏è</span> D√ºz…ôli≈ü et
                            </div>
                            <div class="action-item delete" onclick="deleteEntryWrapper('${i.isRecurring ? 'recurring' : 'manual'}', '${i.isRecurring ? i.originalId : i.date+'|'+i.type+'|'+i.amount}', '${i.monthYear}')">
                                <span>üóëÔ∏è</span> Sil
                            </div>
                        </div>
                    </td>
                `;
                document.getElementById(i.type==='gelir'?'gelirBody':'xercBody').appendChild(r);
            });
            renderChartAndAnnualStats(displayData);
            renderMultiCalendar(displayData, selectedMonth); // Render New Calendar
        }

        function addEntry() {
            const c = document.getElementById('category').value; const n = document.getElementById('note').value; const a = parseFloat(document.getElementById('amount').value); const d = document.getElementById('date').value;
            if(!c || !a || !d) { alert('M…ôlumatlarƒ± doldurun'); return; } const dt = new Date(d); const my = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
            data.push({type: currentType, category: c, note: n, amount: a, date: d, monthYear: my}); localStorage.setItem('budgetApp2025', JSON.stringify(data)); document.getElementById('note').value=''; document.getElementById('amount').value=''; render();
        }

        init();
    </script>
</body>
</html>